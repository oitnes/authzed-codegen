# `authzed-codegen`

This repository contains a Type-Safe Code Generation tool for [SpiceDB](https://authzed.com/docs/spicedb) schemas.

[AuthZed](https://authzed.com/) is a powerful authorization engine built around [SpiceDB](https://spicedb.io/) that allows you to define and manage your authorization policies using the Zanzibar-inspired schema language. This code generation tool parses SpiceDB `.zed` schema files and generates type-safe Go code, making it easier to work with your authorization policies in a compile-time safe manner.

**TLDR**: `.zed` schema files → type-safe Go code generation.

```zed
// Example SpiceDB schema with complex permission expressions
definition platform {
	relation administrator: user
	relation registered_user: user
	relation anonim_user: user:*

	permission super_admin = administrator
	permission create_forum = registered_user
	permission view = anonim_user + registered_user + administrator
}

definition public_forum {
	relation global: platform
	relation owner: user
	relation admin: user
	relation member: user
	relation banned: user

	permission own = owner
	permission edit_admin_list = own + global->super_admin
	permission edit = owner + admin + global->super_admin
	permission view = edit + member + global->view - banned
	permission make_post = (owner + admin + member) - banned
}
```

```go
// Usage example with generated code
package main

import (
    "context"
    "log"
)

func main() {
    ctx := context.Background()
    
    // Create instances using generated types
    forum := PublicForum("forum-123")
    user := User("user-456")
    admin := User("admin-789")

    // Create relationships using generated methods
    err := forum.CreateOwnerRelations(ctx, PublicForumOwnerObjects{
        User: []User{admin},
    })
    if err != nil {
        log.Fatal(err)
    }

    // Create member relations
    err = forum.CreateMemberRelations(ctx, PublicForumMemberObjects{
        User: []User{user},
    })
    if err != nil {
        log.Fatal(err)
    }

    // Check permissions using generated methods
    canView, err := forum.CheckView(ctx, CheckPublicForumViewInputs{
        User: []User{user},
    })
    if err != nil {
        log.Fatal(err)
    }
    
    if canView {
        log.Println("User can view the forum")
    }
}
```

```go
// publicforum_gen.go
// Code generated by spicedb-gen, DO NOT EDIT.

package main

import (
  "github.com/oitnes/authzed-codegen/pkg/authz"
  "context"
)

const TypePublicForum authz.Type = "/public_forum"
type RelationPublicForum authz.Relation
type PermissionPublicForum authz.Permission

// Generated relation constants and object types
const PublicForumGlobal RelationPublicForum = "global"
type PublicForumGlobalObjects struct {
  Platform []Platform
}

const PublicForumOwner RelationPublicForum = "owner"
type PublicForumOwnerObjects struct {
  User []User
}

// Generated permission constants and input types
const PublicForumView PermissionPublicForum = "view"
type CheckPublicForumViewInputs struct {
  User []User
  Platform []Platform
}

// Generated type and utility functions
type PublicForum authz.ID

func (forum PublicForum) CreateOwnerRelations(ctx context.Context, objects PublicForumOwnerObjects) error {
  // Implementation for creating owner relations...
}

func (forum PublicForum) CheckView(ctx context.Context, input CheckPublicForumViewInputs) (bool, error) {
  // Implementation for checking view permissions...
}

// Many more generated methods for CRUD operations, permission checks, and lookups...
```


## Installation

### From Go Install

```bash
go install github.com/oitnes/authzed-codegen/cmd/authzed-codegen@latest
```

### From Source

```bash
git clone https://github.com/oitnes/authzed-codegen.git
cd authzed-codegen
make build
# or
go build -o authzed-codegen ./cmd/authzed-codegen
```

## Usage

Generate Go code from SpiceDB schema files:

```sh
authzed-codegen --schema path/to/schema.zed --output path/to/output/directory
```

### Command Line Options

- `--schema` or `-schema`: Path to the input `.zed` schema file (required)
- `--output` or `-output`: Output directory for generated Go files (required)

### Examples

```sh
# Generate code for a single schema file
./authzed-codegen --schema examples/example_1.zed --output ./generated

# Generate code for another schema
./authzed-codegen --schema examples/example_2.zed --output ./output
```

## Features

### ✅ Supported SpiceDB Schema Features

- **Definitions**: Object type definitions with relations and permissions
- **Relations**: Type-safe relation definitions with union types (e.g., `user | customer`)
- **Permissions**: Complex permission expressions with full operator support:
  - `+` (Union): Combines relations/permissions
  - `-` (Exclusion): Removes subjects from a set  
  - `&` (Intersection): Finds common subjects
  - `->` (Arrow): Traverses object hierarchies for nested permissions
  - `()` (Grouping): Parentheses for expression precedence
  - `|` (Union): Union of relation types
  - `:*` (Wildcard): Universal access patterns
- **Namespaces**: Support for prefixed definitions (e.g., `menusvc/order`, `bookingsvc/booking`)
- **Comments**: Line comments (`//`) and block comments (`/* */`)

### Generated Go Code Includes

- **Type-safe constants** for all object types, relations, and permissions
- **Struct types** for relationship objects and permission input validation
- **CRUD operations** for relationships:
  - `Create{Relation}Relations()` - Create new relationships
  - `Delete{Relation}Relations()` - Remove relationships  
  - `Read{Relation}{Type}Relations()` - Read existing relationships
- **Permission checking** methods:
  - `Check{Permission}()` - Verify if permission is granted
  - `Lookup{Permission}Resources()` - Find resources with permission
  - `Lookup{Permission}{Type}Subjects()` - Find subjects with permission
- **Utility functions** for type conversion and ID management

### Architecture

- **Integrated lexer and parser** built from scratch for SpiceDB schema language
- **Template-based code generation** using Go's `text/template`
- **Permission tree resolution** for complex permission inheritance
- **Type inference** from schema definitions to generate appropriate Go types

## Examples

Check the `examples/` folder for sample `.zed` schema files:
- `example_1.zed` - Multi-service booking and menu system (14 definitions)
- `example_2.zed` - Forum system with complex permissions (5 definitions)

## Project Structure

```
authzed-codegen/
├── cmd/authzed-codegen/     # CLI application entry point
├── internal/generator/      # Core code generation logic
│   ├── zed_lexer/          # SpiceDB schema lexer
│   ├── generator.go        # Parser and code generator
│   └── object.go.tmpl      # Go code generation template
├── pkg/authz/              # Runtime authorization library
├── examples/               # Example schema files
└── README.md
```

## Dependencies

The generated code depends on the `authz` package which provides:
- SpiceDB client integration
- Type definitions for resources, relations, and permissions
- Runtime methods for authorization operations

## Contributing

Contributions are welcome! Please:

1. Open an issue to discuss proposed changes
2. Fork the repository and create a feature branch
3. Add tests for new functionality
4. Submit a pull request with a clear description

### Development

```sh
# Run tests
go test ./...

# Test with example schemas
go build ./cmd/authzed-codegen
./authzed-codegen --schema examples/example_1.zed --output test_output
```

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
